# Promptfoo Config: Test LLM Action Result Formatting
# Tests that AI responses don't contain raw JSON after action execution

description: "Test that formatActionResultForAI produces clean, natural responses"

prompts:
  - |
    Du er Friday, en dansk AI assistent for Rendetalje.
    Du har netop udfÃ¸rt en handling og fÃ¥et dette resultat:
    
    {{actionResult}}
    
    PrÃ¦senter resultatet naturligt til brugeren pÃ¥ dansk uden at vise tekniske detaljer eller JSON.

providers:
  # Test with single free tier model to avoid rate limits
  - id: openrouter:deepseek/deepseek-chat-v3.1:free
    config:
      temperature: 0.3

tests:
  # Test 1: Calendar event result (from screenshot)
  - vars:
      actionResult: |
        [Handling UdfÃ¸rt] âœ… Succes: Du har **1 aftale** i dag
        
        Resultater (1 element):
        1. ReligiÃ¸s vielse (Nikah / Ù‚Ø±Ø§Ù†) - Fouad Amer Hodaifa og Diana El Zahr - Fredens Moske, Edwin Rahrs Vej 1, BrÃ¸nderslev BrÃ¸ndersslev
        
        ğŸ’¡ PrÃ¦senter nu resultatet naturligt til brugeren pÃ¥ dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "[Handling UdfÃ¸rt]"
      - type: not-contains
        value: "ğŸ’¡"
      - type: contains
        value: "kalender"
      - type: contains
        value: "aftale"
      - type: javascript
        value: |
          output.split('\n').length <= 5  # Should be concise

  # Test 2: Multiple results (leads/emails)
  - vars:
      actionResult: |
        [Handling UdfÃ¸rt] âœ… Succes: Fundet 3 nye leads
        
        Resultater (3 elementer):
        1. FlytterengÃ¸ring - KÃ¸benhavn
        2. Vinduespudsning - Aarhus
        3. KontorrengÃ¸ring - Odense
        
        ğŸ’¡ PrÃ¦senter nu resultatet naturligt til brugeren pÃ¥ dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "[Handling"
      - type: contains-any
        value: ["leads", "opgaver", "henvendelser"]
      - type: javascript
        value: |
          const lines = output.split('\n').filter(l => l.trim());
          lines.length >= 2 && lines.length <= 6  # Structured but concise

  # Test 3: Error case
  - vars:
      actionResult: |
        [Handling UdfÃ¸rt] âŒ Fejl: Kunne ikke oprette faktura
        
        âš ï¸ Teknisk fejl: Billy API returned 401 Unauthorized
        
        ğŸ’¡ PrÃ¦senter nu resultatet naturligt til brugeren pÃ¥ dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "Billy API"
      - type: not-contains
        value: "401"
      - type: contains-any
        value: ["fejl", "problem", "ikke"]
      - type: javascript
        value: |
          !output.toLowerCase().includes('unauthorized')  # No technical errors

  # Test 4: Simple success
  - vars:
      actionResult: |
        [Handling UdfÃ¸rt] âœ… Succes: Opgave oprettet
        
        ğŸ’¡ PrÃ¦senter nu resultatet naturligt til brugeren pÃ¥ dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "[Handling"
      - type: contains-any
        value: ["oprettet", "tilfÃ¸jet", "gemt", "fÃ¦rdig"]
      - type: is-json
        value: false

defaultTest:
  options:
    # Ensure no raw JSON in any output
    postprocess: |
      if (output.includes('{') && output.includes('}') && output.includes('"')) {
        throw new Error('Output contains raw JSON structure');
      }
      return output;
