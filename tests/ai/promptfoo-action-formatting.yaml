# Promptfoo Config: Test LLM Action Result Formatting
# Tests that AI responses don't contain raw JSON after action execution

description: "Test that formatActionResultForAI produces clean, natural responses"

prompts:
  - |
    Du er Friday, en dansk AI assistent for Rendetalje.
    Du har netop udf√∏rt en handling og f√•et dette resultat:
    
    {{actionResult}}
    
    Pr√¶senter resultatet naturligt til brugeren p√• dansk uden at vise tekniske detaljer eller JSON.

providers:
  # Test with new free models
  - id: openrouter:glm-4.5-air-free
    config:
      temperature: 0.3
  - id: openrouter:deepseek-chat-v3.1-free
    config:
      temperature: 0.3
  - id: openrouter:gemma-3-27b-free # Legacy for comparison
    config:
      temperature: 0.3

tests:
  # Test 1: Calendar event result (from screenshot)
  - vars:
      actionResult: |
        [Handling Udf√∏rt] ‚úÖ Succes: Du har **1 aftale** i dag
        
        Resultater (1 element):
        1. Religi√∏s vielse (Nikah / ŸÇÿ±ÿßŸÜ) - Fouad Amer Hodaifa og Diana El Zahr - Fredens Moske, Edwin Rahrs Vej 1, Br√∏nderslev Br√∏ndersslev
        
        üí° Pr√¶senter nu resultatet naturligt til brugeren p√• dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "[Handling Udf√∏rt]"
      - type: not-contains
        value: "üí°"
      - type: contains
        value: "kalender"
      - type: contains
        value: "aftale"
      - type: javascript
        value: |
          output.split('\n').length <= 5  # Should be concise

  # Test 2: Multiple results (leads/emails)
  - vars:
      actionResult: |
        [Handling Udf√∏rt] ‚úÖ Succes: Fundet 3 nye leads
        
        Resultater (3 elementer):
        1. Flyttereng√∏ring - K√∏benhavn
        2. Vinduespudsning - Aarhus
        3. Kontorreng√∏ring - Odense
        
        üí° Pr√¶senter nu resultatet naturligt til brugeren p√• dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "[Handling"
      - type: contains-any
        value: ["leads", "opgaver", "henvendelser"]
      - type: javascript
        value: |
          const lines = output.split('\n').filter(l => l.trim());
          lines.length >= 2 && lines.length <= 6  # Structured but concise

  # Test 3: Error case
  - vars:
      actionResult: |
        [Handling Udf√∏rt] ‚ùå Fejl: Kunne ikke oprette faktura
        
        ‚ö†Ô∏è Teknisk fejl: Billy API returned 401 Unauthorized
        
        üí° Pr√¶senter nu resultatet naturligt til brugeren p√• dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "Billy API"
      - type: not-contains
        value: "401"
      - type: contains-any
        value: ["fejl", "problem", "ikke"]
      - type: javascript
        value: |
          !output.toLowerCase().includes('unauthorized')  # No technical errors

  # Test 4: Simple success
  - vars:
      actionResult: |
        [Handling Udf√∏rt] ‚úÖ Succes: Opgave oprettet
        
        üí° Pr√¶senter nu resultatet naturligt til brugeren p√• dansk uden at vise tekniske detaljer eller JSON.
    assert:
      - type: not-contains
        value: "{"
      - type: not-contains
        value: "[Handling"
      - type: contains-any
        value: ["oprettet", "tilf√∏jet", "gemt", "f√¶rdig"]
      - type: is-json
        value: false

defaultTest:
  options:
    # Ensure no raw JSON in any output
    postprocess: |
      if (output.includes('{') && output.includes('}') && output.includes('"')) {
        throw new Error('Output contains raw JSON structure');
      }
      return output;
